name: Release Binaries and Publish NPM Packages

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  macos-arm64:
    name: macOS arm64 (darwin-arm64)
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      - name: Build binary with PyInstaller
        run: |
          uv venv .venv -p $PYTHON_VERSION
          uv pip install -p .venv/bin/python -U pip setuptools wheel pyinstaller
          uv pip install -p .venv/bin/python -U .
          .venv/bin/python -m PyInstaller -F -n adorable src/adorable_cli/main.py
      - name: Prepare subpackage and publish
        if: startsWith(github.ref, 'refs/tags/')
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          PKG_VERSION=$(node -p "require('./package.json').version")
          SUB_DIR="npm/adorable-cli-darwin-arm64"
          PKG_NAME=$(node -p "require('./$SUB_DIR/package.json').name")
          cp -f dist/adorable "$SUB_DIR/vendor/adorable"
          CUR=$(node -p "require('./$SUB_DIR/package.json').version")
          echo "Main version: $PKG_VERSION; Subpackage: $PKG_NAME@$CUR"
          npm config set //registry.npmjs.org/:_authToken "${NODE_AUTH_TOKEN}"
          npm whoami || { echo "NPM auth failed. Ensure NPM_TOKEN is set."; exit 1; }
          if [ "$CUR" != "$PKG_VERSION" ]; then
            (cd "$SUB_DIR" && npm version "$PKG_VERSION" --no-git-tag-version)
          else
            echo "Version unchanged ($CUR), skipping npm version"
          fi
          PUBLISHED=$(npm view "$PKG_NAME" version 2>/dev/null || echo "")
          if [ "$PUBLISHED" = "$PKG_VERSION" ]; then
            echo "Already published $PKG_NAME@$PUBLISHED, skipping publish."
          else
            (cd "$SUB_DIR" && npm publish --access public)
          fi

  macos-x64:
    name: macOS x64 (darwin-x64)
    runs-on: macos-13
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      - name: Build binary with PyInstaller
        run: |
          uv venv .venv -p $PYTHON_VERSION
          uv pip install -p .venv/bin/python -U pip setuptools wheel pyinstaller
          uv pip install -p .venv/bin/python -U .
          .venv/bin/python -m PyInstaller -F -n adorable src/adorable_cli/main.py
      - name: Prepare subpackage and publish
        if: startsWith(github.ref, 'refs/tags/')
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          PKG_VERSION=$(node -p "require('./package.json').version")
          SUB_DIR="npm/adorable-cli-darwin-x64"
          PKG_NAME=$(node -p "require('./$SUB_DIR/package.json').name")
          cp -f dist/adorable "$SUB_DIR/vendor/adorable"
          CUR=$(node -p "require('./$SUB_DIR/package.json').version")
          echo "Main version: $PKG_VERSION; Subpackage: $PKG_NAME@$CUR"
          npm config set //registry.npmjs.org/:_authToken "${NODE_AUTH_TOKEN}"
          npm whoami || { echo "NPM auth failed. Ensure NPM_TOKEN is set."; exit 1; }
          if [ "$CUR" != "$PKG_VERSION" ]; then
            (cd "$SUB_DIR" && npm version "$PKG_VERSION" --no-git-tag-version)
          else
            echo "Version unchanged ($CUR), skipping npm version"
          fi
          PUBLISHED=$(npm view "$PKG_NAME" version 2>/dev/null || echo "")
          if [ "$PUBLISHED" = "$PKG_VERSION" ]; then
            echo "Already published $PKG_NAME@$PUBLISHED, skipping publish."
          else
            (cd "$SUB_DIR" && npm publish --access public)
          fi

  linux-x64:
    name: Linux x64 (linux-x64)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      - name: Build binary with PyInstaller
        run: |
          uv venv .venv -p $PYTHON_VERSION
          uv pip install -p .venv/bin/python -U pip setuptools wheel pyinstaller
          uv pip install -p .venv/bin/python -U .
          .venv/bin/python -m PyInstaller -F -n adorable src/adorable_cli/main.py
      - name: Prepare subpackage and publish
        if: startsWith(github.ref, 'refs/tags/')
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          PKG_VERSION=$(node -p "require('./package.json').version")
          SUB_DIR="npm/adorable-cli-linux-x64"
          PKG_NAME=$(node -p "require('./$SUB_DIR/package.json').name")
          cp -f dist/adorable "$SUB_DIR/vendor/adorable"
          CUR=$(node -p "require('./$SUB_DIR/package.json').version")
          echo "Main version: $PKG_VERSION; Subpackage: $PKG_NAME@$CUR"
          npm config set //registry.npmjs.org/:_authToken "${NODE_AUTH_TOKEN}"
          npm whoami || { echo "NPM auth failed. Ensure NPM_TOKEN is set."; exit 1; }
          if [ "$CUR" != "$PKG_VERSION" ]; then
            (cd "$SUB_DIR" && npm version "$PKG_VERSION" --no-git-tag-version)
          else
            echo "Version unchanged ($CUR), skipping npm version"
          fi
          PUBLISHED=$(npm view "$PKG_NAME" version 2>/dev/null || echo "")
          if [ "$PUBLISHED" = "$PKG_VERSION" ]; then
            echo "Already published $PKG_NAME@$PUBLISHED, skipping publish."
          else
            (cd "$SUB_DIR" && npm publish --access public)
          fi

  linux-arm64:
    name: Linux arm64 (linux-arm64)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Enable QEMU for cross-arch containers
        uses: docker/setup-qemu-action@v3
      - name: Build inside manylinux aarch64 container
        run: |
          docker run --rm --platform linux/arm64 -e PYTHON_VERSION=$PYTHON_VERSION -v "$PWD":/workspace -w /workspace quay.io/pypa/manylinux2014_aarch64 bash -lc '
            set -euo pipefail
            curl -LsSf https://astral.sh/uv/install.sh | sh
            # Install Rust toolchain for building rust-based Python extensions (e.g., tiktoken)
            curl -sSf https://sh.rustup.rs | sh -s -- -y
            export PATH="$HOME/.cargo/bin:$PATH"
            [ -f "$HOME/.cargo/env" ] && source "$HOME/.cargo/env"
            rustc --version || true
            cargo --version || true
            uv venv .venv -p $PYTHON_VERSION
            uv pip install -p .venv/bin/python -U pip setuptools wheel pyinstaller
            # Use locked dependency versions correctly: export the lockfile and sync
            if [ -f uv.lock ]; then
              uv export --format requirements-txt -o requirements.lock.txt
              uv pip sync -p .venv/bin/python requirements.lock.txt
              # Install our local package without re-resolving deps
              uv pip install -p .venv/bin/python -U --no-deps .
            else
              uv pip install -p .venv/bin/python -U .
            fi
            .venv/bin/python -m PyInstaller -F -n adorable src/adorable_cli/main.py
          '
      - name: Prepare subpackage and publish
        if: startsWith(github.ref, 'refs/tags/')
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          PKG_VERSION=$(node -p "require('./package.json').version")
          SUB_DIR="npm/adorable-cli-linux-arm64"
          PKG_NAME=$(node -p "require('./$SUB_DIR/package.json').name")
          cp -f dist/adorable "$SUB_DIR/vendor/adorable"
          CUR=$(node -p "require('./$SUB_DIR/package.json').version")
          echo "Main version: $PKG_VERSION; Subpackage: $PKG_NAME@$CUR"
          npm config set //registry.npmjs.org/:_authToken "${NODE_AUTH_TOKEN}"
          npm whoami || { echo "NPM auth failed. Ensure NPM_TOKEN is set."; exit 1; }
          if [ "$CUR" != "$PKG_VERSION" ]; then
            (cd "$SUB_DIR" && npm version "$PKG_VERSION" --no-git-tag-version)
          else
            echo "Version unchanged ($CUR), skipping npm version"
          fi
          PUBLISHED=$(npm view "$PKG_NAME" version 2>/dev/null || echo "")
          if [ "$PUBLISHED" = "$PKG_VERSION" ]; then
            echo "Already published $PKG_NAME@$PUBLISHED, skipping publish."
          else
            (cd "$SUB_DIR" && npm publish --access public)
          fi

  windows-x64:
    name: Windows x64 (win32-x64)
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Install uv
        shell: powershell
        run: |
          irm https://astral.sh/uv/install.ps1 | iex
      - name: Build binary with PyInstaller
        shell: bash
        run: |
          uv venv .venv -p $PYTHON_VERSION
          uv pip install -p .venv/Scripts/python.exe -U pip setuptools wheel pyinstaller
          uv pip install -p .venv/Scripts/python.exe -U .
          .venv/Scripts/python.exe -m PyInstaller -F -n adorable src/adorable_cli/main.py
      - name: Prepare subpackage and publish
        if: startsWith(github.ref, 'refs/tags/')
        shell: bash
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          PKG_VERSION=$(node -p "require('./package.json').version")
          SUB_DIR="npm/adorable-cli-win32-x64"
          PKG_NAME=$(node -p "require('./$SUB_DIR/package.json').name")
          cp -f dist/adorable.exe "$SUB_DIR/vendor/adorable.exe"
          CUR=$(node -p "require('./$SUB_DIR/package.json').version")
          echo "Main version: $PKG_VERSION; Subpackage: $PKG_NAME@$CUR"
          npm config set //registry.npmjs.org/:_authToken "${NODE_AUTH_TOKEN}"
          npm whoami || { echo "NPM auth failed. Ensure NPM_TOKEN is set."; exit 1; }
          if [ "$CUR" != "$PKG_VERSION" ]; then
            (cd "$SUB_DIR" && npm version "$PKG_VERSION" --no-git-tag-version)
          else
            echo "Version unchanged ($CUR), skipping npm version"
          fi
          PUBLISHED=$(npm view "$PKG_NAME" version 2>/dev/null || echo "")
          if [ "$PUBLISHED" = "$PKG_VERSION" ]; then
            echo "Already published $PKG_NAME@$PUBLISHED, skipping publish."
          else
            (cd "$SUB_DIR" && npm publish --access public)
          fi

  publish-main:
    name: Publish main package
    needs: [macos-arm64, macos-x64, linux-x64, linux-arm64, windows-x64]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Sync optionalDependencies to current version
        run: |
          node -e "const fs=require('fs');const p=require('./package.json');const v=p.version;['adorable-cli-darwin-arm64','adorable-cli-darwin-x64','adorable-cli-linux-x64','adorable-cli-linux-arm64','adorable-cli-win32-x64'].forEach(k=>p.optionalDependencies[k]='^'+v);fs.writeFileSync('package.json', JSON.stringify(p, null, 2));"
      - name: Publish main package
        if: startsWith(github.ref, 'refs/tags/')
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          PKG_VERSION=$(node -p "require('./package.json').version")
          npm config set //registry.npmjs.org/:_authToken "${NODE_AUTH_TOKEN}"
          npm whoami || { echo "NPM auth failed. Ensure NPM_TOKEN is set."; exit 1; }
          CURRENT=$(npm view adorable-cli version 2>/dev/null || echo "")
          if [ "$CURRENT" = "$PKG_VERSION" ]; then
            echo "Already published adorable-cli@$CURRENT, skipping publish."
          else
            npm publish --access public
          fi